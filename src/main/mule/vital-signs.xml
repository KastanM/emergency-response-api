<mule xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:db="http://www.mulesoft.org/schema/mule/db" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
	http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
	http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">
  <sub-flow name="addVitalSign">
        <logger doc:name="Logger" doc:id="loktuz" message="hello worlds"/>
        <logger doc:name="Logger" doc:id="ktrkfq" message="hello world"/>
        <db:insert config-ref="Config" doc:name="Insert" doc:id="pmlqlh" target="insertResult" autoGenerateKeys="true" autoGeneratedKeysColumnNames="#[[&quot;vital_id&quot;, &quot;created_at&quot;]]">
            <db:sql><![CDATA[INSERT INTO vital_signs (
    er_id,
    recorded_at,
    heart_rate,
    blood_pressure_systolic,
    blood_pressure_diastolic,
    blood_oxygen,
    temperature,
    respiratory_rate,
    source,
    device_id,
    connectivity_type,
    notes,
    created_at
  )
VALUES (
    :emergencyResponseId,
    :recorded,
    :heartRate,
    :bloodPressureSystolic,
    :bloodPressureDiastolic,
    :bloodOxygen,
    :temperature,
    :respiratoryRate,
    :source,
    :deviceId,
    :connectivityType,
    :notes,
    NOW()
  );]]></db:sql>
            <db:input-parameters><![CDATA[#[{
  emergencyResponseId: payload.emergencyResponseid,
  recorded: payload.recorded as DateTime { class: "java.sql.Date" },
  heartRate: payload.patientVitals.heartRate,
  bloodPressureSystolic: payload.patientVitals.bloodPressure.systolic,
  bloodPressureDiastolic: payload.patientVitals.bloodPressure.diastolic,
  bloodOxygen: payload.patientVitals.bloodOxygen,
  temperature: payload.patientVitals.temperature,
  respiratoryRate: payload.patientVitals.respiratoryRate,
  source: payload.source,
  deviceId: null,
  connectivityType: null,
  notes: null,
}]]]></db:input-parameters>
        </db:insert>
        <logger doc:name="Logger" doc:id="tuqzxi" message="#[output application/json    ---   vars.insertResult ]" />
        <ee:transform doc:name="Transform" doc:id="xebpra">
            <ee:message>
                <ee:set-payload doc:name="Set payload" doc:id="sazzlz"><![CDATA[%dw 2.0
output application/json
var newRecordId = vars.insertResult.generatedKeys.vital_id 
---
payload -"patientVitals" ++ { 
  id: newRecordId}
]]></ee:set-payload>
            </ee:message>
        </ee:transform>
    
  </sub-flow>
  
</mule>
